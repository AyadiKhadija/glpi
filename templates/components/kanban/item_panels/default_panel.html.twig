{% import 'components/form/fields_macros.html.twig' as fields %}

<div class="item-details-panel" data-itemtype="{{ itemtype }}" data-items_id="{{ item_fields.id }}">
   <div class="card d-flex flex-column h-100">
      <div class="card-header d-block">
         <h5 class="card-title">
            <a href="{{ itemtype|itemtype_form_path(item_fields.id) }}">
               <i class="{{ itemtype|itemtype_icon }}" title="{{ itemtype|itemtype_name }}"></i>
               {{ item_fields.name }}
            </a>
            <button type="button" class="btn-link" onclick="$(this).closest('.item-details-panel').remove()"><i class="fas fa-times"></i></button>
         </h5>
         <h6 class="card-subtitle">
            {% if item_fields.is_milestone %}
                  <i class="fas fa-map-signs me-2"></i>{{ __('Milestone') }}
            {% endif %}
         </h6>
      </div>
      <div class="card-body overflow-auto">
         {% macro print_hook_section(name, itemtype, items_id) %}
            {% set content = call_plugin_hook_func(name, {
               "itemtype": itemtype,
               "items_id": items_id
            }, true) %}
            {% if content is not empty and content['content']|trim is not empty %}
               {{ content['content']|raw }}
               <hr>
            {% endif %}
         {% endmacro %}
         {{ _self.print_hook_section('pre_kanban_panel_content', itemtype, item_fields.id) }}
         {{ _self.print_hook_section('pre_kanban_panel_main_content', itemtype, item_fields.id) }}

         {% set preview = item_fields.content|length > 1000 ? item_fields.content|slice(0, 1000) ~ ' (...)' : item_fields.content %}
         {{ fields.textareaField('content', preview, '', {
            "enable_richtext": true,
            "no_label": true,
            "full_width": true,
            "disabled": true,
         }) }}
         <hr>

         {{ _self.print_hook_section('post_kanban_panel_main_content', itemtype, item_fields.id) }}

         <h5 class="d-flex justify-content-between">
            <span>{{ __('Team') }}</span>
            <button type="button" class="btn-link kanban-item-edit-team"><i class="fas fa-plus"></i></button>
         </h5>
         {% if team is not empty %}
            {# Ungroup team and move the keys to an itemtype property, then regroup by role #}
            {% set team_by_role = team|ungroup('itemtype')|group_by('role') %}
            {% for team_role,team_members in team_by_role %}
               <h5>{{ itemtype|team_role_name(team_role, get_plural_number()) }}</h5>
               <ul class="list-group team-list" data-role="{{ team_role }}">
                  {% for team_member in team_members %}
                     <li class="list-group-item d-flex justify-content-between" data-itemtype="{{ team_member.itemtype }}"
                         data-items_id="{{ team_member.items_id }}" data-name="{{ team_member.display_name|default(team_member.name) }}">
                        {# Contents added in Kanban JS #}
                     </li>
                  {% endfor %}
               </ul>
            {% endfor %}
         {% else %}
            {{ __('No team members') }}
         {% endif %}
         <hr>

         {{ _self.print_hook_section('post_kanban_panel_content', itemtype, item_fields.id) }}
      </div>
      <div class="card-footer border-top flex-shrink-0 text-center p-3">
         <a class="btn btn-outline w-100" target="_blank" rel="noopener" href="{{ itemtype|itemtype_form_path(item_fields.id) }}">
            <span class="pr-1">{{ __('Open full form') }}</span>
         </a>
      </div>
   </div>
</div>
